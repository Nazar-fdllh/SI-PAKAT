<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dokumentasi API SI-PAKAT</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 960px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        h1 { font-size: 2.5em; }
        h2 { font-size: 2em; margin-top: 40px; }
        h3 { font-size: 1.5em; margin-top: 30px; border-bottom: 1px solid #e0e0e0; }
        .endpoint { background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .method { font-family: monospace; font-weight: bold; border-radius: 5px; padding: 5px 10px; color: #fff; display: inline-block; font-size: 1.1em; }
        .method.post { background-color: #28a745; }
        .method.get { background-color: #007bff; }
        .method.put { background-color: #fd7e14; }
        .method.delete { background-color: #dc3545; }
        .url { font-family: monospace; background-color: #e9ecef; padding: 5px 10px; border-radius: 5px; color: #495057; font-size: 1.1em; }
        .description { margin-top: 15px; color: #666; }
        .section-title { font-weight: bold; margin-top: 20px; color: #34495e; }
        pre { background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        code { font-family: "Courier New", Courier, monospace; }
        .note { background-color: #fff3cd; border-left: 5px solid #ffeeba; padding: 15px; margin-top: 20px; }
        .note strong { color: #856404; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        ol li { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Dokumentasi API SI-PAKAT</h1>
    <p>Dokumentasi RESTful API untuk Sistem Informasi Pengelolaan Keamanan Aset TIK. Semua endpoint, kecuali login, memerlukan otorisasi menggunakan Bearer Token.</p>
    <p><strong>Base URL:</strong> <code>http://localhost:3001</code></p>

    <div class="note">
        <strong>Penting:</strong> Untuk semua request yang memerlukan autentikasi, sertakan header berikut:
        <pre><code>Authorization: Bearer <JWT_TOKEN_ANDA></code></pre>
    </div>

    <!-- ====================================================================== -->
    <!--                      AUTHENTICATION SECTION                          -->
    <!-- ====================================================================== -->
    <h2><span style="color:#6f42c1;">&#x1F511;</span> Autentikasi</h2>
    <div class="endpoint">
        <h3>Login Pengguna</h3>
        <p><span class="method post">POST</span> <span class="url">/api/auth/login</span></p>
        <p class="description">Endpoint untuk mengautentikasi pengguna, mendapatkan token JWT, dan memperbarui `last_login_at`. Endpoint ini dilindungi oleh CAPTCHA.</p>

        <p class="section-title">Request Body</p>
        <pre><code>{
    "email": "admin@sipakat.com",
    "password": "password123",
    "g-recaptcha-response": "TOKEN_DARI_CAPTCHA_FRONTEND"
}</code></pre>

        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>{
    "id": 1,
    "name": "Admin Utama",
    "email": "admin@sipakat.com",
    "role": "Administrator",
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}</code></pre>
        <p class="section-title">Kemungkinan Error</p>
        <ul>
            <li><strong>400 Bad Request:</strong> Email/password tidak diisi atau verifikasi CAPTCHA gagal.</li>
            <li><strong>401 Unauthorized:</strong> Password salah.</li>
            <li><strong>404 Not Found:</strong> Email tidak ditemukan.</li>
        </ul>
    </div>

     <div class="endpoint">
        <h3>Lupa Password</h3>
        <p><span class="method post">POST</span> <span class="url">/api/auth/forgot-password</span></p>
        <p class="description">Memulai proses reset password. Backend akan mengirimkan email berisi link reset ke pengguna.</p>

        <p class="section-title">Request Body</p>
        <pre><code>{
    "email": "pengguna.lupa@sipakat.com"
}</code></pre>

        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>{
    "message": "Jika email Anda terdaftar, Anda akan menerima link reset password."
}</code></pre>
    </div>

     <div class="endpoint">
        <h3>Reset Password</h3>
        <p><span class="method post">POST</span> <span class="url">/api/auth/reset-password</span></p>
        <p class="description">Menyelesaikan proses reset password dengan token yang valid.</p>

        <p class="section-title">Request Body</p>
        <pre><code>{
    "token": "TOKEN_DARI_URL_EMAIL",
    "password": "passwordBaruSuperAman123"
}</code></pre>

        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>{
    "message": "Password Anda telah berhasil direset. Silakan login."
}</code></pre>
         <p class="section-title">Kemungkinan Error</p>
         <ul>
            <li><strong>400 Bad Request:</strong> Token tidak valid atau telah kedaluwarsa.</li>
         </ul>
    </div>

    <!-- ====================================================================== -->
    <!--                           USERS SECTION                              -->
    <!-- ====================================================================== -->
    <h2><span style="color:#007bff;">&#x1F465;</span> Manajemen Pengguna (Hanya Admin)</h2>
    
    <div class="endpoint">
        <h3><span class="method get">GET</span> <span class="url">/api/users</span></h3>
        <p class="description">Mengambil daftar semua pengguna terdaftar, termasuk `last_login_at`.</p>
        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>[
    {
        "id": 1,
        "name": "Admin Utama",
        "email": "admin@sipakat.com",
        "role": "Administrator",
        "role_id": 1,
        "last_login_at": "2023-10-27T10:30:00.000Z"
    },
    {
        "id": 2,
        "name": "Budi Manajer",
        "email": "budi.manajer@sipakat.com",
        "role": "Manajer Aset",
        "role_id": 2,
        "last_login_at": null
    }
]</code></pre>
    </div>

    <div class="endpoint">
        <h3><span class="method post">POST</span> <span class="url">/api/users</span></h3>
        <p class="description">Membuat pengguna baru. Endpoint ini divalidasi agar field `username` hanya berisi huruf dan spasi.</p>
        <p class="section-title">Request Body</p>
        <pre><code>{
    "username": "Citra Auditor",
    "email": "citra@sipakat.com",
    "password": "newpassword123",
    "role_id": 3
}</code></pre>
        <p class="section-title">Contoh Response Sukses (201 Created)</p>
        <pre><code>{
    "id": 3,
    "username": "Citra Auditor",
    "email": "citra@sipakat.com",
    "role_id": 3
}</code></pre>
    </div>

     <div class="endpoint">
        <h3><span class="method get">GET</span> <span class="url">/api/users/{id}</span></h3>
        <p class="description">Mengambil detail satu pengguna berdasarkan ID-nya.</p>
        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>{
    "id": 2,
    "name": "Budi Manajer",
    "email": "budi.manajer@sipakat.com",
    "role_id": 2,
    "last_login_at": null
}</code></pre>
    </div>

    <div class="endpoint">
        <h3><span class="method put">PUT</span> <span class="url">/api/users/{id}</span></h3>
        <p class="description">Memperbarui data pengguna. `username` divalidasi hanya huruf dan spasi. `password` opsional.</p>
        <p class="section-title">Request Body</p>
        <pre><code>{
    "username": "Budi Hartono",
    "email": "budi.hartono@sipakat.com",
    "role_id": 2,
    "password": "newpassword456" 
}</code></pre>
        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>{
    "message": "Pengguna berhasil diperbarui"
}</code></pre>
    </div>

    <div class="endpoint">
        <h3><span class="method delete">DELETE</span> <span class="url">/api/users/{id}</span></h3>
        <p class="description">Menghapus pengguna dari sistem.</p>
        <p class="section-title">Contoh Response Sukses (204 No Content)</p>
        <p>Tidak ada body respons.</p>
    </div>

    <!-- ====================================================================== -->
    <!--                          ASSETS SECTION                              -->
    <!-- ====================================================================== -->
    <h2><span style="color:#28a745;">&#x1F4BB;</span> Manajemen Aset</h2>
     <div class="endpoint">
        <h3><span class="method get">GET</span> <span class="url">/api/assets/next-code</span></h3>
        <p class="description">Menghasilkan kode aset berikutnya secara otomatis. Berguna untuk form entry di frontend.</p>
        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>{
    "next_code": "AST-0005"
}</code></pre>
    </div>

    <div class="endpoint">
        <h3><span class="method get">GET</span> <span class="url">/api/assets</span></h3>
        <p class="description">Mengambil daftar semua aset TIK (bisa diakses oleh semua peran terautentikasi). Termasuk nilai aset terakhir.</p>
        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>[
    {
        "id": 1,
        "asset_code": "AST-0001",
        "asset_name": "Server Enttron",
        "classification_id": 3,
        "sub_classification_id": 6,
        "identification_of_existence": "Fisik",
        "location": "Data Center Diskominfo Kalsel",
        "owner": "Diskominfo",
        "category_name": "Perangkat Keras",
        "asset_value": "Tinggi"
    }
]</code></pre>
    </div>
    
     <div class="endpoint">
        <h3><span class="method get">GET</span> <span class="url">/api/assets/details/{id}</span></h3>
        <p class="description">Mengambil detail lengkap satu aset, termasuk data dari tabel anak yang relevan (SDM, hardware, dll.).</p>
        <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>// Contoh untuk aset Perangkat Keras (classification_id: 3)
{
    "id": 1,
    "asset_code": "AST-0001",
    "asset_name": "Server Enttron",
    "classification_id": 3,
    "sub_classification_id": 6,
    "identification_of_existence": "Fisik",
    "location": "Data Center Diskominfo Kalsel",
    "owner": "Diskominfo",
    "created_at": "2023-10-27T08:00:00.000Z",
    "updated_at": "2023-10-27T08:00:00.000Z",
    "confidentiality_score": 3,
    "integrity_score": 3,
    "availability_score": 2,
    "authenticity_score": 3,
    "non_repudiation_score": 2,
    "brand": "Dell",
    "model": "PowerEdge R740",
    "serial_number": "SN12345XYZ",
    "specification": "RAM 64GB, CPU Xeon Silver",
    "condition": "Baik"
}</code></pre>
    </div>

    <div class="endpoint">
        <h3><span class="method post">POST</span> <span class="url">/api/assets</span></h3>
        <p class="description">Menambah aset baru beserta penilaian awal dan data detailnya (hanya Admin/Manajer Aset).</p>
        <div class="note">
            <strong>Catatan:</strong> Field <code>total_score</code> dan <code>asset_value</code> tidak perlu dikirim. Keduanya dihitung otomatis oleh backend.
        </div>
        <p class="section-title">Request Body (Contoh untuk Aset SDM)</p>
        <pre><code>{
    "asset_code": "AST-0005",
    "asset_name": "Analis Keamanan Siber",
    "classification_id": 1,
    "identification_of_existence": "Personil",
    "location": "Kantor Pusat",
    "owner": "Divisi TI",
    "assessed_by": 2,
    "confidentiality_score": 3,
    "integrity_score": 2,
    "availability_score": 2,
    "authenticity_score": 1,
    "non_repudiation_score": 1,
    "personnel_name": "Rina Anggraini",
    "employee_id_number": "NIP987654",
    "function": "Analisis",
    "position": "Analis Junior"
}</code></pre>
        <p class="section-title">Contoh Response Sukses (201 Created)</p>
        <p>Akan mengembalikan data aset yang baru dibuat.</p>
    </div>

    <div class="endpoint">
        <h3><span class="method put">PUT</span> <span class="url">/api/assets/{id}</span></h3>
        <p class="description">Memperbarui data dasar aset DAN/ATAU data tabel anak. Jika skor penilaian disertakan, akan membuat **catatan penilaian baru**.</p>
        <p class="section-title">Request Body (Contoh: Update data dasar & data anak)</p>
        <pre><code>{
    "asset_name": "Server Enttron V2",
    "location": "Data Center Utama",
    "owner": "Divisi Infrastruktur TI",
    "model": "PowerEdge R750", // Field dari tabel anak 'hardware_details'
    "specification": "RAM 128GB, CPU Xeon Gold"
}</code></pre>
         <p class="section-title">Contoh Response Sukses (200 OK)</p>
        <pre><code>{
    "message": "Aset berhasil diperbarui."
}</code></pre>
    </div>

     <div class="endpoint">
        <h3><span class="method delete">DELETE</span> <span class="url">/api/assets/{id}</span></h3>
        <p class="description">Menghapus aset (hanya Admin/Manajer Aset). Ini juga akan menghapus semua data terkait di tabel anak dan riwayat penilaiannya karena `ON DELETE CASCADE`.</p>
         <p class="section-title">Contoh Response Sukses (204 No Content)</p>
        <p>Tidak ada body respons.</p>
    </div>

    <!-- ====================================================================== -->
    <!--                          REPORTS SECTION                             -->
    <!-- ====================================================================== -->
    <h2><span style="color:#fd7e14;">&#x1F4C4;</span> Pelaporan</h2>
    <div class="endpoint">
        <h3><span class="method get">GET</span> <span class="url">/api/reports</span></h3>
        <p class="description">Menghasilkan laporan aset dengan filter (hanya Admin/Auditor).</p>
        <p class="section-title">Query Parameters (Opsional)</p>
        <table>
            <tr><th>Nama</th><th>Tipe</th><th>Contoh Nilai</th><th>Deskripsi</th></tr>
            <tr><td>categoryId</td><td>string</td><td>`2` atau `all`</td><td>Filter berdasarkan ID kategori aset.</td></tr>
            <tr><td>asset_value</td><td>string</td><td>`Tinggi`, `Sedang`, `Rendah`, `Semua`</td><td>Filter berdasarkan nilai klasifikasi aset.</td></tr>
        </table>
        <p>Contoh URL dengan filter: <code>/api/reports?categoryId=3&asset_value=Tinggi</code></p>
    </div>

</body>
</html>
```